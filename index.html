<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="keywords" content="" />
  <meta name="description" content="" />
  <meta name="author" content="" />
  <title>ASC</title>

  <script src="lesson.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="style.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="sub_page">
  <div id="app">
    <div class="hero_area">
      <div class="hero_bg_box"></div>
      <header class="header_section">
        <div class="container-fluid">
          <nav class="navbar navbar-expand-lg custom_nav-container ">
            <a class="navbar-brand" href="index.html">
              <span>ASC</span>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="navbar-nav">
                <li class="nav-item active">
                  <form class="form-inline">
                    <button @click.prevent="toggleCartVisibility" :disabled="cart.length === 0">
                      Shopping Cart ({{ totalSpacesInCart }})
                    </button>
                  </form>
                </li>
              </ul>
            </div>
          </nav>
        </div>
      </header>
    </div>

    <section class="slider_section">
      <div id="customCarousel1" class="carousel slide" data-ride="carousel">
        <div class="carousel-inner">
          <div class="carousel-item active">
            <div class="container">
              <div class="row">
                <div class="col-md-6">
                  <div class="detail-box">
                    <h2>
                      After School <br>
                      Classes
                    </h2>
                    <p>
                      Welcome to After School Classes!
                      Your source for a productive and fun way to utilize your time.
                      We offer courses, which allows students and their parents to buy after school classes and
                      activities.
                      So stop searching and start your journey today!
                    </p>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="img-box">
                    <img src="slider-img.png" alt="">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="service_section layout_padding" v-if="!showProduct">
      <div class="service_container">
        <div class="container">
          <div class="heading_container heading_center">
            <h2>Our <span>Classes</span></h2>
            <p>Please take a look at the courses that we proudly offer, here at ASC</p>
          </div>
          <br>

          <div>
            <label for="sortAttribute">Sort by:</label>
            <select id="sortAttribute" v-model="sortAttribute">
              <option disabled value="">Sort</option>
              <option value="subject">Subject</option>
              <option value="location">Location</option>
              <option value="price">Price</option>
              <option value="spaces">Spaces</option>
            </select>
            <label for="sortOrder">Order:</label>
            <select id="sortOrder" v-model="sortOrder">
              <option disabled value="">Order</option>
              <option value="asc">Ascending</option>
              <option value="desc">Descending</option>
            </select>
            <button @click="sortLessons">Sort</button>
          </div>
          <br>

          <input type="text" v-model="searchTerm" @input="searchLessons" placeholder="Search lessons">

          <div v-for="lesson in filteredLessons" :key="lesson.id">
            <figure>
              <img v-bind:src="lesson.image" alt="" width="100" height="90">
            </figure>
            <h2 v-text="lesson.title"></h2>
            <p v-text="'Subject: ' + lesson.subject"></p>
            <p v-text="'Location: ' + lesson.location"></p>
            <p v-text="'Price: ' + lesson.price"></p>
            <p v-text="'Spaces: ' + lesson.spaces"></p>
            <button @click="addToCart(lesson)" :disabled="!canAddToCart(lesson)">Add To Cart</button>
            <span v-if="lesson.availableInventory === 0">All out!</span>
          </div>
        </div>
      </div>
    </section>

    <section id="cartSection" v-if="showProduct" class="team_section layout_padding"></section>

    <section v-if="showProduct" class="team_section layout_padding">
      <div class="container-fluid">
        <div class="heading_container heading_center">
          <p>Your Cart</p> <br>

          <div v-if="cart.length === 0">
            <p>Your cart is empty.</p>
          </div>

          <div v-else>
            <div v-for="cartItem in cart" :key="cartItem.id">
              <div>
                <img v-bind:src="cartItem.image" alt="" width="100" height="90">
              </div>
              <div>
                <p>{{ cartItem.subject }}</p>
                <p>{{ 'Location: ' + cartItem.location }}</p>
                <p>{{ 'Price: ' + cartItem.price }}</p>
                <p>{{ 'Spaces: ' + cartItem.spaces }}</p>
                <button @click="removeFromCart(cartItem.id)">Remove</button>
              </div>
            </div>
          </div>

          <br>
          <form id="checkoutForm">
            <input type="text" id="name" placeholder="Enter your Name" pattern="[A-Za-z ]+" required
              v-model="order.firstName">
            <input type="tel" id="phone" placeholder="Enter your Phone number" pattern="[0-9]+" required
              v-model="order.lastName">
            <button @click="checkout" :disabled="!isCheckoutEnabled">Checkout</button>
            <p v-if="orderSubmitted">Order submitted!</p>
          </form>
        </div>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var webstore = new Vue({
        el: '#app',
        data: {
          showProduct: false,
          products: lessons,
          searchTerm: '',
          order: {
            method: 'Home',
          },
          cart: [],
          orderSubmitted: false,
          sortAttribute: '',
          sortOrder: '',
        },
        methods: {
          fetchLessons: function () {
            fetch('/lessons')
              .then(response => response.json())
              .then(data => {
                this.products = data;
              })
              .catch(error => console.error('Error fetching lessons:', error));
          },
          toggleCartVisibility: function () {
            const wasVisible = this.showProduct;
            this.showProduct = !this.showProduct;

            if (this.showProduct) {
              const cartSection = document.getElementById('cartSection');
              if (cartSection) {
                cartSection.scrollIntoView({ block: 'start', inline: 'nearest', behavior: 'smooth' });
              }
            } else {
              const lessonsSection = document.getElementById('lessonsSection');
              if (lessonsSection) {
                lessonsSection.scrollIntoView({ block: 'start', inline: 'nearest', behavior: 'smooth' });
              }
            }
          },
          addToCart: function (product) {
            console.log('addToCart called', product);
            if (product.availableInventory > 0) {
              this.cart.push({ ...product });
              product.availableInventory--;
              product.spaces--;
            }
          },
          sortLessons: function () {
            if (this.sortAttribute && this.sortOrder) {
              this.products.sort((a, b) => {
                const valueA = a[this.sortAttribute];
                const valueB = b[this.sortAttribute];
                return this.sortOrder === 'asc' ? (valueA < valueB ? -1 : 1) : (valueA > valueB ? -1 : 1);
              });
            }
          },
          canAddToCart: function (product) {
            return product.spaces > 0;
          },
          removeFromCart: function (lessonId) {
            const lessonIndex = this.cart.findIndex(item => item.id === lessonId);
            if (lessonIndex !== -1) {
              const removedLesson = this.cart.splice(lessonIndex, 1)[0];
              const originalLesson = this.getProductById(lessonId);
              if (originalLesson) {
                originalLesson.availableInventory++;
                originalLesson.spaces++;
              }
            }
          },
          getLessonDetails: function (lessonId) {
            const lesson = this.getProductById(lessonId);
            return lesson ? lesson : null;
          },
          getProductById: function (productId) {
            return this.products.find(product => product.id === productId);
          },
          proceedToCheckout: function () {
            console.log('Proceeding to checkout...');
            this.cart = [];
            this.showProduct = true;
          },
          checkout: function () {
            if (this.isValidName() && this.isValidPhone()) {
              // Extract lesson IDs from the cart
              const lessonIds = this.cart.map(item => item.id);

              // Prepare order data
              const orderData = {
                name: this.order.firstName,
                phoneNumber: this.order.lastName,
                lessonIds: lessonIds,
                numberOfSpace: this.cart.length,
              };

              // Send the order data to the server
              this.saveOrder(orderData);

              // Clear cart and show order submitted message
              this.cart = [];
              this.showProduct = true;
              this.orderSubmitted = true;
            }
          },
          saveOrder: function (orderData) {
            axios.post('/orders', orderData)
              .then(response => {
                console.log('Order submitted successfully!', response.data);
              })
              .catch(error => {
                console.error('Error submitting order:', error);
              });
          },
          isValidName: function () {
            const nameRegex = /^[A-Za-z ]+$/;
            return nameRegex.test(this.order.firstName);
          },
          isValidPhone: function () {
            const phoneRegex = /^[0-9]+$/;
            return phoneRegex.test(this.order.lastName);
          },
        },
        computed: {
          filteredLessons: function () {
            const term = this.searchTerm.toLowerCase();
            return this.products.filter(
              (lesson) =>
                lesson.subject.toLowerCase().includes(term) ||
                lesson.location.toLowerCase().includes(term)
            );
          },
          isCheckoutEnabled: function () {
            return this.cart.length > 0 && this.isValidName() && this.isValidPhone();
          },
          cartItemCount: function () {
            return this.cart.length || '';
          },
          totalSpacesInCart: function () {
            return this.cart.length;
          },
          sortedProducts: function () {
            return this.products;
          },
        },
        created() {
          this.fetchLessons(); // Fetch lessons on component creation
        },
      });
    });
  </script>
</body>

</html>
